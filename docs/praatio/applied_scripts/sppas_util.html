<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.5.2" />
<title>praatio.applied_scripts.sppas_util API documentation</title>
<meta name="description" content="Created on Dec 5, 2016 â€¦" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{font-weight:bold}#index h4 + ul{margin-bottom:.6em}#index .two-column{column-count:2}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.name small{font-weight:normal}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase;cursor:pointer}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title"><code>praatio.applied_scripts.sppas_util</code> module</h1>
</header>
<section id="section-intro">
<p>Created on Dec 5, 2016</p>
<p>This script modifies the output of sppas, a forced-aligner tool, by
renaming the textgrids, removing tiers, renaming tiers, and changing
the contents of some tiers.</p>
<dl>
<dt>For more information on SPPAS visit the SPPAS homepage:</dt>
<dt><strong><code>http</code></strong> :&ensp;//<code>www.sppas.org</code>/</dt>
<dd>&nbsp;</dd>
<dt>or</dt>
<dt><strong><code>https</code></strong> :&ensp;//<code>github.com</code>/<code>brigittebigi</code>/<code>sppas</code></dt>
<dd>&nbsp;</dd>
</dl>
<p>@author: Tim Mahrt</p>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">&#39;&#39;&#39;
Created on Dec 5, 2016

This script modifies the output of sppas, a forced-aligner tool, by
renaming the textgrids, removing tiers, renaming tiers, and changing
the contents of some tiers.

For more information on SPPAS visit the SPPAS homepage:
http://www.sppas.org/
or
https://github.com/brigittebigi/sppas

@author: Tim Mahrt
&#39;&#39;&#39;

import io
import os
from os.path import join
import shutil

from praatio import tgio
from praatio import praatio_scripts
from praatio.utilities import utils
from praatio.applied_scripts import xsampa

# The SPPAS-produced tiers to delete
# You probably don&#39;t want to remove items from this list but you could
# add to it (for example, if a new version of SPPAS adds new tiers)
REMOVE_TIER_LIST = [&#34;Information&#34;, &#34;PhnTokAlign&#34;,
                    &#34;Phonetization&#34;, &#34;Transcription&#34;,
                    &#34;Information-2&#34;, &#34;MetaInformation&#34;,
                    &#34;Activity&#34;, &#34;Tokenization-Standard&#34;,
                    ]

# The SPPAS-produced tiers to rename
# Format: (from_name, to_name)
RENAME_TIER_LIST = [(&#34;Tokenization&#34;, &#34;IPUs&#34;),
                    (&#34;TokensAlign&#34;, &#34;words&#34;),
                    (&#34;PhonAlign&#34;, &#34;phones&#34;),
                    ]


def _decimalEqual(a, b, threshold=1e-04):
    return abs(a - b) &lt; threshold


def _xsampaToIPATier(tg, tierName):
    
    tier = tg.tierDict[tierName]
    entryList = []
    for start, stop, label in tier.entryList:
        try:
            label = xsampa.xs2uni(label)
        except AssertionError:
            pass
        entryList.append((start, stop, label))
    
    tier = tgio.IntervalTier(tierName, entryList, 0, tg.maxTimestamp)
    tg.replaceTier(tierName, tier)
    
    return tg


def sppasPostProcess(tgPath, outputPath, removeTierList=None,
                     renameTierList=None, deleteIntermediateFiles=False):
    &#39;&#39;&#39;
    Cleanup SPPAS output files. Remove unused tier names.  Rename tier names.
    
    If /deleteIntermediateFiles/ is True, the xra and intermediate textgrids
    produced by SPPAS will be deleted.
    
    If /replaceOrigTextgrids/ is True, the input textgrids to SPPAS will be
    replaced by the textgrids SPPAS outputs
    &#39;&#39;&#39;
    
    if not os.path.exists(outputPath):
        os.mkdir(outputPath)
    
    if removeTierList is None:
        removeTierList = REMOVE_TIER_LIST
    
    if renameTierList is None:
        renameTierList = RENAME_TIER_LIST
    
    # Remove intermediate files
    if deleteIntermediateFiles is True:
        lowerTGList = utils.findFiles(tgPath, filterExt=&#34;.textgrid&#34;)
        xraList = utils.findFiles(tgPath, &#34;.xra&#34;)
        removeList = lowerTGList + xraList
        for fn in removeList:
            os.remove(join(tgPath, fn))
    
    # Replace the textgrids input to SPPAS (suffixed with &#39;-merge&#39;)
    # with the textgrids that SPPAS output
    tgFNList = utils.findFiles(tgPath, filterExt=&#34;.TextGrid&#34;)
    tgFNList = [fn for fn in tgFNList
                if &#39;-merge&#39; in fn]
    
    # Clean up the textgrids output by SPPAS
    # Rename tiers, delete tiers, and convert the phonetic tier
    # from xsampa to IPA
    for mergeFN in tgFNList:
        
        mergeName = os.path.splitext(mergeFN)[0]
        nonMergeName = mergeName.split(&#39;-merge&#39;)[0]
        if not os.path.exists(join(outputPath, nonMergeName + &#34;.wav&#34;)):
            shutil.copy(join(tgPath, nonMergeName + &#34;.wav&#34;),
                        join(outputPath, nonMergeName + &#34;.wav&#34;))
        if os.path.exists(join(outputPath, nonMergeName + &#34;.TextGrid&#34;)):
            print(&#34;Skipping %s -- already exists&#34; % mergeName + &#34;.TextGrid&#34;)
            continue
        
        # Open tg file and remove jittered boundaries
        tg = praatio_scripts.alignBoundariesAcrossTiers(join(tgPath, mergeFN),
                                                        maxDifference=0.001)
        # Remove tiers
        for name in removeTierList:
            if name in tg.tierNameList:
                tg.removeTier(name)
        
        # Rename tiers
        for fromName, toName in renameTierList:
            if fromName in tg.tierNameList:
                tg.renameTier(fromName, toName)
        
        # Convert phones to IPA
        tg = _xsampaToIPATier(tg, &#34;phones&#34;)
        
#         # Typically, the start and end of a spass file is silent but an
#         # utterance with only a single ipu will not acount for this.  Make
#         # a tiny amount of space for the user to be able to shift the
#         # tier if needed.
#         for tierName in tg.tierNameList:
#             tier = tg.tierDict[tierName]
#             start, stop, label = tier.entryList[0]
#             if decimalEqual(start, 0) and stop &gt; 0.01:
#                 tier.entryList[0] = (0.01, stop, label)
#
#             start, stop, label = tier.entryList[-1]
#             duration = tg.maxTimestamp
#             if decimalEqual(stop, duration) and start &lt; duration - 0.01:
#                 tier.entryList[-1] = (start, duration - 0.01, label)
        
        tg.save(join(outputPath, nonMergeName + &#34;.TextGrid&#34;))
        

def generateSingleIPUTextgrids(wavPath, txtPath, outputPath, nameMod=None,
                               addPause=True):
    &#39;&#39;&#39;
    Generates a textgrid with a single IPU for each wave file
    
    This constitutes the first step of SPPAS, chunking a recording into
    utterances.  In the cases when there is only a single utterance, SPPAS
    sometimes makes errors (or is not configured properly by the user).  This
    script is strictly for those situations.
    
    If there are multiple audio files for each transcript, you can derive the
    transcript name using /nameMod/
    
    If there is a chance of even a slight segment of silence on the edges of
    the audio file, /addPause/ should be True.
    &#39;&#39;&#39;
    if nameMod is None:
        nameMod = lambda x: x

    if not os.path.exists(outputPath):
        os.mkdir(outputPath)
    
    wavList = utils.findFiles(wavPath, filterExt=&#34;.wav&#34;, stripExt=True)
    
    for wavName in wavList:
        
        transcriptName = nameMod(wavName)
        
        # Add initial and final small pauses to each transcript
        with io.open(join(txtPath, transcriptName + &#34;.txt&#34;), &#34;r&#34;) as fd:
            txt = fd.read()
            
        if addPause is True:
            txt = &#34;+ %s +&#34; % txt.lower()

        wavFN = join(wavPath, wavName + &#34;.wav&#34;)
        dur = praatio_scripts.audioio.WavQueryObj(wavFN).getDuration()
        tg = tgio.Textgrid()
        tier = tgio.IntervalTier(&#34;ipu&#34;, [(0, dur, txt), ], 0, dur)
        
        tg.addTier(tier)
        tg.save(join(outputPath, wavName + &#34;.TextGrid&#34;))</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="praatio.applied_scripts.sppas_util.generateSingleIPUTextgrids"><code class="name flex">
<span>def <span class="ident">generateSingleIPUTextgrids</span></span>(<span>wavPath, txtPath, outputPath, nameMod=None, addPause=True)</span>
</code></dt>
<dd>
<section class="desc"><p>Generates a textgrid with a single IPU for each wave file</p>
<p>This constitutes the first step of SPPAS, chunking a recording into
utterances.
In the cases when there is only a single utterance, SPPAS
sometimes makes errors (or is not configured properly by the user).
This
script is strictly for those situations.</p>
<p>If there are multiple audio files for each transcript, you can derive the
transcript name using /nameMod/</p>
<p>If there is a chance of even a slight segment of silence on the edges of
the audio file, /addPause/ should be True.</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def generateSingleIPUTextgrids(wavPath, txtPath, outputPath, nameMod=None,
                               addPause=True):
    &#39;&#39;&#39;
    Generates a textgrid with a single IPU for each wave file
    
    This constitutes the first step of SPPAS, chunking a recording into
    utterances.  In the cases when there is only a single utterance, SPPAS
    sometimes makes errors (or is not configured properly by the user).  This
    script is strictly for those situations.
    
    If there are multiple audio files for each transcript, you can derive the
    transcript name using /nameMod/
    
    If there is a chance of even a slight segment of silence on the edges of
    the audio file, /addPause/ should be True.
    &#39;&#39;&#39;
    if nameMod is None:
        nameMod = lambda x: x

    if not os.path.exists(outputPath):
        os.mkdir(outputPath)
    
    wavList = utils.findFiles(wavPath, filterExt=&#34;.wav&#34;, stripExt=True)
    
    for wavName in wavList:
        
        transcriptName = nameMod(wavName)
        
        # Add initial and final small pauses to each transcript
        with io.open(join(txtPath, transcriptName + &#34;.txt&#34;), &#34;r&#34;) as fd:
            txt = fd.read()
            
        if addPause is True:
            txt = &#34;+ %s +&#34; % txt.lower()

        wavFN = join(wavPath, wavName + &#34;.wav&#34;)
        dur = praatio_scripts.audioio.WavQueryObj(wavFN).getDuration()
        tg = tgio.Textgrid()
        tier = tgio.IntervalTier(&#34;ipu&#34;, [(0, dur, txt), ], 0, dur)
        
        tg.addTier(tier)
        tg.save(join(outputPath, wavName + &#34;.TextGrid&#34;))</code></pre>
</details>
</dd>
<dt id="praatio.applied_scripts.sppas_util.sppasPostProcess"><code class="name flex">
<span>def <span class="ident">sppasPostProcess</span></span>(<span>tgPath, outputPath, removeTierList=None, renameTierList=None, deleteIntermediateFiles=False)</span>
</code></dt>
<dd>
<section class="desc"><p>Cleanup SPPAS output files. Remove unused tier names.
Rename tier names.</p>
<p>If /deleteIntermediateFiles/ is True, the xra and intermediate textgrids
produced by SPPAS will be deleted.</p>
<p>If /replaceOrigTextgrids/ is True, the input textgrids to SPPAS will be
replaced by the textgrids SPPAS outputs</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def sppasPostProcess(tgPath, outputPath, removeTierList=None,
                     renameTierList=None, deleteIntermediateFiles=False):
    &#39;&#39;&#39;
    Cleanup SPPAS output files. Remove unused tier names.  Rename tier names.
    
    If /deleteIntermediateFiles/ is True, the xra and intermediate textgrids
    produced by SPPAS will be deleted.
    
    If /replaceOrigTextgrids/ is True, the input textgrids to SPPAS will be
    replaced by the textgrids SPPAS outputs
    &#39;&#39;&#39;
    
    if not os.path.exists(outputPath):
        os.mkdir(outputPath)
    
    if removeTierList is None:
        removeTierList = REMOVE_TIER_LIST
    
    if renameTierList is None:
        renameTierList = RENAME_TIER_LIST
    
    # Remove intermediate files
    if deleteIntermediateFiles is True:
        lowerTGList = utils.findFiles(tgPath, filterExt=&#34;.textgrid&#34;)
        xraList = utils.findFiles(tgPath, &#34;.xra&#34;)
        removeList = lowerTGList + xraList
        for fn in removeList:
            os.remove(join(tgPath, fn))
    
    # Replace the textgrids input to SPPAS (suffixed with &#39;-merge&#39;)
    # with the textgrids that SPPAS output
    tgFNList = utils.findFiles(tgPath, filterExt=&#34;.TextGrid&#34;)
    tgFNList = [fn for fn in tgFNList
                if &#39;-merge&#39; in fn]
    
    # Clean up the textgrids output by SPPAS
    # Rename tiers, delete tiers, and convert the phonetic tier
    # from xsampa to IPA
    for mergeFN in tgFNList:
        
        mergeName = os.path.splitext(mergeFN)[0]
        nonMergeName = mergeName.split(&#39;-merge&#39;)[0]
        if not os.path.exists(join(outputPath, nonMergeName + &#34;.wav&#34;)):
            shutil.copy(join(tgPath, nonMergeName + &#34;.wav&#34;),
                        join(outputPath, nonMergeName + &#34;.wav&#34;))
        if os.path.exists(join(outputPath, nonMergeName + &#34;.TextGrid&#34;)):
            print(&#34;Skipping %s -- already exists&#34; % mergeName + &#34;.TextGrid&#34;)
            continue
        
        # Open tg file and remove jittered boundaries
        tg = praatio_scripts.alignBoundariesAcrossTiers(join(tgPath, mergeFN),
                                                        maxDifference=0.001)
        # Remove tiers
        for name in removeTierList:
            if name in tg.tierNameList:
                tg.removeTier(name)
        
        # Rename tiers
        for fromName, toName in renameTierList:
            if fromName in tg.tierNameList:
                tg.renameTier(fromName, toName)
        
        # Convert phones to IPA
        tg = _xsampaToIPATier(tg, &#34;phones&#34;)
        
#         # Typically, the start and end of a spass file is silent but an
#         # utterance with only a single ipu will not acount for this.  Make
#         # a tiny amount of space for the user to be able to shift the
#         # tier if needed.
#         for tierName in tg.tierNameList:
#             tier = tg.tierDict[tierName]
#             start, stop, label = tier.entryList[0]
#             if decimalEqual(start, 0) and stop &gt; 0.01:
#                 tier.entryList[0] = (0.01, stop, label)
#
#             start, stop, label = tier.entryList[-1]
#             duration = tg.maxTimestamp
#             if decimalEqual(stop, duration) and start &lt; duration - 0.01:
#                 tier.entryList[-1] = (start, duration - 0.01, label)
        
        tg.save(join(outputPath, nonMergeName + &#34;.TextGrid&#34;))</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="praatio.applied_scripts" href="index.html">praatio.applied_scripts</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="praatio.applied_scripts.sppas_util.generateSingleIPUTextgrids" href="#praatio.applied_scripts.sppas_util.generateSingleIPUTextgrids">generateSingleIPUTextgrids</a></code></li>
<li><code><a title="praatio.applied_scripts.sppas_util.sppasPostProcess" href="#praatio.applied_scripts.sppas_util.sppasPostProcess">sppasPostProcess</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.5.2</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>